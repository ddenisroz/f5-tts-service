#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Модуль для ёфикации русского текста
Основан на python-yoficator: https://github.com/Text-extend-tools/python-yoficator
"""

import os
import re
import codecs
import logging
from pathlib import Path

# Настройка логирования
logger = logging.getLogger(__name__)

class Yoficator:
    """Ёфикатор для русского текста"""
    
    def __init__(self, dictionary_path=None):
        """
        Инициализация ёфикатора
        
        Args:
            dictionary_path: Путь к файлу словаря yo.dat
        """
        if dictionary_path is None:
            # Ищем файл yo.dat в папке python-yoficator
            current_dir = Path(__file__).parent
            dictionary_path = current_dir / "python-yoficator" / "yo.dat"
        
        self.dictionary_path = dictionary_path
        self.dictionary = {}
        self.splitter = re.compile(r'(\s+|\w+|\W+|\S+)', re.UNICODE)
        
        logger.info(f"Загружаем словарь ёфикации из: {self.dictionary_path}")
        # Загружаем словарь
        self._load_dictionary()
    
    def _load_dictionary(self):
        """Загружает словарь для ёфикации"""
        try:
            with codecs.open(self.dictionary_path, "r", "utf-8") as f:
                for line in f:
                    if not "*" in line:
                        cline = line.rstrip('\n')
                        if "(" in cline:
                            bline, sline = cline.split("(")
                            sline = re.sub(r'\)', '', sline)
                        else:
                            bline = cline
                            sline = ""
                        
                        if "|" in sline:
                            ssline = sline.split("|")
                            for ss in ssline:
                                value = bline + ss
                                key = re.sub(r'ё', 'е', value)
                                self.dictionary[key] = value
                        else:
                            value = bline
                            key = re.sub(r'ё', 'е', value)
                            self.dictionary[key] = value
            
            logger.info(f"Словарь ёфикации загружен успешно. Записей: {len(self.dictionary)}")
        except FileNotFoundError:
            logger.warning(f"Словарь {self.dictionary_path} не найден. Ёфикация отключена.")
            self.dictionary = {}
    
    def yoficate(self, text):
        """
        Ёфицирует русский текст
        
        Args:
            text: Исходный текст
            
        Returns:
            Ёфицированный текст
        """
        if not self.dictionary:
            return text
        
        # Разбиваем текст на токены
        tokens = self.splitter.findall(text)
        result = []
        
        for token in tokens:
            if token in self.dictionary:
                result.append(self.dictionary[token])
            else:
                # Дополнительные правила для слов, которых нет в словаре
                yoficated_token = self._apply_additional_rules(token)
                result.append(yoficated_token)
        
        return ''.join(result)
    
    def _apply_additional_rules(self, word: str) -> str:
        """Применяет дополнительные правила ёфикации для слов, которых нет в словаре."""
        if not word or not word.isalpha():
            return word
        
        import re
        word_lower = word.lower()
        
        # 1. Частые слова и исключения
        common_words = {
            "еще": "ещё",
            "ее": "её", 
            "телка": "тёлка",
            "осел": "осёл",
            "произнес": "произнёс",
            "шел": "шёл",
            "вел": "вёл",
            "жел": "жёл",
            "мел": "мёл",
            "тел": "тёл",
            "че": "чё",
            "чё": "чё",
            # Дополнительные частые слова
            "все": "всё",
            "всего": "всего",  # не ёфицируем
            "всегда": "всегда",  # не ёфицируем
            "везде": "везде",  # не ёфицируем
            "всех": "всех",  # не ёфицируем
            "всем": "всем",  # не ёфицируем
            "всеми": "всеми",  # не ёфицируем
            "всему": "всему",  # не ёфицируем
            "всей": "всей",  # не ёфицируем
            "всю": "всю",  # не ёфицируем
            "всё": "всё",  # уже ёфицировано
            "цена": "цена"  # не ёфицируем
        }
        
        if word_lower in common_words:
            return word.replace(word_lower, common_words[word_lower])
        
        # 2. Глаголы прошедшего времени (заканчивающиеся на "ел")
        if word_lower.endswith("ел") and len(word) > 3:
            # Расширенный список исключений - глаголы где НЕ нужна буква ё
            exceptions = [
                # Общие исключения
                "медведь", "привет", "удел", "предел", "дела", "как", "гетеро",
                # Глаголы, которые не меняют "е" на "ё"
                "хотел", "хотела", "хотели", "хотело",
                "умел", "умела", "умели", "умело",
                "смел", "смела", "смели", "смело",
                "имел", "имела", "имели", "имело",
                "сел", "села", "сели", "село",
                "пел", "пела", "пели", "пело",
                # Глаголы, которые вообще не используют "ё"
                "смотрел", "смотрела", "смотрели",
                "думал", "думала", "думали",
                "знал", "знала", "знали",
                "был", "была", "были", "было",
                "жил", "жила", "жили", "жило",
                "пил", "пила", "пили", "пило",
                "ел", "ела", "ели", "ело",
                "спал", "спала", "спали", "спало",
                "встал", "встала", "встали", "встало",
                "упал", "упала", "упали", "упало",
                "взял", "взяла", "взяли", "взяло",
                "дал", "дала", "дали", "дало",
                "стал", "стала", "стали", "стало",
                "читал", "читала", "читали",
                "писал", "писала", "писали",
                "рисовал", "рисовала", "рисовали",
                "играл", "играла", "играли",
                "работал", "работала", "работали",
                "учился", "училась", "учились",
                "гулял", "гуляла", "гуляли",
                "ходил", "ходила", "ходили",
                "бегал", "бегала", "бегали",
                "прыгал", "прыгала", "прыгали",
                "танцевал", "танцевала", "танцевали",
                "учил", "учила", "учили",
                "слушал", "слушала", "слушали",
                "говорил", "говорила", "говорили",
                "понимал", "понимала", "понимали",
                "чувствовал", "чувствовала", "чувствовали",
                # Дополнительные исключения
                "летел", "летела", "летели", "летело",
                "сидел", "сидела", "сидели", "сидело",
                "лежал", "лежала", "лежали", "лежало",
                "стоял", "стояла", "стояли", "стояло",
                "висел", "висела", "висели", "висело",
                "светел", "светела", "светели", "светело",
                "темнел", "темнела", "темнели", "темнело",
                "зеленел", "зеленела", "зеленели", "зеленело",
                "краснел", "краснела", "краснели", "краснело",
                "белел", "белела", "белели", "белело",
                "чернел", "чернела", "чернели", "чернело",
                "желтел", "желтела", "желтели", "желтело",
                "синел", "синела", "синели", "синело"
            ]
            if word_lower not in exceptions:
                return word.replace("ел", "ёл")
        
        # 3. Прилагательные женского рода (заканчивающиеся на "ая") - НЕ ёфицируем
        # Все цветовые прилагательные остаются без ё
        
        # 4. Слова с "е" в корне, заканчивающиеся на "а" (женский род)
        if word_lower.endswith("а") and "е" in word_lower[:-1] and len(word) > 3:
            exceptions = [
                "дела", "щелка", "мелка", "желтка", "белка", "зеленка", "краснка", "стена", "ерунда",
                "река", "лека", "мека", "нека", "века", "сека", "тека", "чека", "шека", "щека",
                "беда", "неда", "веда", "седа", "теда", "чеда", "шеда", "щеда",
                "мера", "вера", "сера", "тера", "чера", "шера", "щера",
                "нега", "вега", "сега", "тега", "чега", "шега", "щега",
                "меха", "веха", "сеха", "теха", "чеха", "шеха", "щеха",
                "меча", "веча", "сеча", "теча", "чеча", "шеча", "щеча",
                "меша", "веша", "сеша", "теша", "чеша", "шеша", "щеша",
                "меща", "веща", "сеща", "теща", "чеща", "шеща", "щеща",
                # [START] FIX: Слова, которые НЕ должны ёфицироваться
                "проверка", "сверка", "переверка", "неверка",
                # Слова с "ерк" в корне - обычно не ёфицируются (но некоторые могут быть в словаре)
                "берка", "верка", "дерка", "жерка", "зерка", "перка", "серка", "терка", "черка", "шерка", "щерка"
            ]
            if word_lower not in exceptions:
                # [START] FIX: Исключаем слова с "ерк" в корне (проверка, сверка, и т.д.)
                if "ерк" in word_lower:
                    return word
                # Заменяем "е" на "ё" в корне, но не в окончании
                return re.sub(r'е([^ё]*а)$', r'ё\1', word)
        
        # 5. Слова с "е" в корне, заканчивающиеся на "о" (средний род)
        if word_lower.endswith("о") and "е" in word_lower[:-1] and len(word) > 3:
            exceptions = [
                "дело", "место", "время", "небо", "поле", "море", "озеро", "дерево", "гетеро",
                "честно", "реально", "идеально", "легально", "нормально", "формально",
                "цена", "веко", "село", "тело", "чело", "шело", "щело",
                "серо", "теро", "черо", "шеро", "щеро",
                "него", "вего", "сего", "тего", "чего", "шего", "щего",
                "мехо", "вехо", "сехо", "техо", "чехо", "шехо", "щехо",
                "мечо", "вечо", "сечо", "течо", "чечо", "шечо", "щечо",
                "мешо", "вешо", "сешо", "тешо", "чешо", "шешо", "щешо",
                "мещо", "вещо", "сещо", "тещо", "чещо", "шещо", "щещо",
                "мело", "вело", "село", "тело", "чело", "шело", "щело",
                "медо", "ведо", "седо", "тедо", "чедо", "шедо", "щедо",
                "меко", "веко", "секо", "теко", "чеко", "шеко", "щеко",
                "мего", "вего", "сего", "тего", "чего", "шего", "щего",
                "мехо", "вехо", "сехо", "техо", "чехо", "шехо", "щехо",
                "мечо", "вечо", "сечо", "течо", "чечо", "шечо", "щечо",
                "мешо", "вешо", "сешо", "тешо", "чешо", "шешо", "щешо",
                "мещо", "вещо", "сещо", "тещо", "чещо", "шещо", "щещо"
            ]
            if word_lower not in exceptions:
                # Заменяем "е" на "ё" в корне, но не в окончании
                return re.sub(r'е([^ё]*о)$', r'ё\1', word)
        
        # 6. Слова с "е" в корне, заканчивающиеся на "ый" (мужской род) - НЕ ёфицируем
        # Все цветовые прилагательные остаются без ё
        
        # 7. Слова с "е" в корне, заканчивающиеся на "ое" (средний род) - НЕ ёфицируем
        # Все цветовые прилагательные остаются без ё
        
        # 8. Слова с "е" в корне, заканчивающиеся на "ие" (множественное число) - НЕ ёфицируем
        # Все цветовые прилагательные остаются без ё
        
        # 9. Слова с "е" в корне, заканчивающиеся на "и" (множественное число) - НЕ ёфицируем
        # Все цветовые прилагательные остаются без ё
        
        # 10. Слова с "е" в корне, заканчивающиеся на "у" (винительный падеж) - НЕ ёфицируем
        # Все цветовые прилагательные остаются без ё
        
        # 11. Слова с "е" в корне, заканчивающиеся на "е" (предложный падеж) - НЕ ёфицируем
        # Все цветовые прилагательные остаются без ё
        
        # 12. Слова с "е" в корне, заканчивающиеся на "ой" (творительный падеж) - НЕ ёфицируем
        # Все цветовые прилагательные остаются без ё
        
        # 13. Слова с "е" в корне, заканчивающиеся на "ом" (творительный падеж) - НЕ ёфицируем
        # Все цветовые прилагательные остаются без ё
        
        # 14. Слова с "е" в корне, заканчивающиеся на "ем" (творительный падеж) - НЕ ёфицируем
        # Все цветовые прилагательные остаются без ё
        
        # 15. Слова с "е" в корне, заканчивающиеся на "ей" (родительный падеж) - НЕ ёфицируем
        # Все цветовые прилагательные остаются без ё
        
        # 16. Слова с "е" в корне, заканчивающиеся на "ей" (дательный падеж) - НЕ ёфицируем
        # Все цветовые прилагательные остаются без ё
        
        # 17. Слова с "е" в корне, заканчивающиеся на "ей" (предложный падеж) - НЕ ёфицируем
        # Все цветовые прилагательные остаются без ё
        
        # 18. Слова с "е" в корне, заканчивающиеся на "ей" (творительный падеж) - НЕ ёфицируем
        # Все цветовые прилагательные остаются без ё
        
        # 19. Слова с "е" в корне, заканчивающиеся на "ей" (родительный падеж) - НЕ ёфицируем
        # Все цветовые прилагательные остаются без ё
        
        # 20. Слова с "е" в корне, заканчивающиеся на "ей" (дательный падеж) - НЕ ёфицируем
        # Все цветовые прилагательные остаются без ё
        
        return word

# Создаем глобальный экземпляр для удобства использования
logger.info("Инициализация ёфикатора...")
yoficator = Yoficator()
logger.info("Ёфикатор инициализирован успешно")

def yoficate_text(text):
    """
    Удобная функция для ёфикации текста
    
    Args:
        text: Исходный текст
        
    Returns:
        Ёфицированный текст
    """
    return yoficator.yoficate(text)

if __name__ == "__main__":
    # Тестирование
    test_text = "елка, медведь, осел, все, еще, ее"
    result = yoficate_text(test_text)
    logger.info(f"Test text: {test_text}")
    logger.info(f"Yoficated result: {result}")
